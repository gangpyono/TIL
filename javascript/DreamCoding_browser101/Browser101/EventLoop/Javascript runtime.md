# 1. js는 싱글 쓰레드 언어.

- js자체에는 멀티쓰레딩을 할 수 있는 방법은 없지만, js가 동작하는 브라우저엔 여러개의 쓰레드가 들어있다. 따라서 브라우저에서 제공하는 웹 API를 이용하면 멀티 쓰레딩이 가능하다.
- Web APIs

  - DOM API
  - setTimeout
  - setinterval
  - fetch
  - eventlistener

  → 자바스크립트가 실행되는 런타임환경(실행환경)에서는 다양한 방식을 통해 멀티쓰레딩 같은 효과를 얻을 수 있다.

  → 또한 이벤트 루프를 통해 좀더 다양한 동작을 실행할 수가 있다.

- 우리의 웹 어플리케이션이 브라우저에 올라가는순간 자바스크립트 엔진이 우리가 작성한 코드를 한줄씩 해석하고 실행한다.
- 이전 프로세스 설명시 프로세스 안에 힙과 스택이 있듯, 자바스크립트 엔진에도 메모리 힙과 콜스택이 있다.
  <img width="700" alt="메모리힙 ,콜스택" src="https://user-images.githubusercontent.com/58588011/118498906-6fc7ae00-b761-11eb-9465-579582364924.png">

<br/><br/>
<br/><br/>

## 1. 메모리 힙

- 변수를 선언하여 오브젝트,문자열,숫자 등을 할당하게되면 메모리힙에 저장된다. (구조적으로 저장이되는것이아닌 산발적으로 저장이됨)

<br/><br/>
<br/><br/>

## 2. 콜스텍

### 정의

- 함수 호출시 호출 정보(프레임)가 쌓이는 곳.

### 특징

- 함수가 실행되는 순서로 쌓임. (LIFO 구조)
- 모든 프로세스와 쓰레드 안에는 각각 저마다의 콜스택을 가지고 있다.
  → 일의 수행순서에대한 정보를 기억해야하기떄문.
- 재귀함수를 이용하여 함수를 무한히 호출할경우 콜스택 사이즈를 초과할 수있기 때문에 재귀함수를 이용시 유의해야한다.
- **콜스택에 등록된 함수는 끝날때까지 보장된다.**
  → 콜스택에 등록된 함수가 실행중 이라면, 이벤트루프는 콜스택에서 대기를 하다가 콜스택이 비워지면 큐에 있는 콜백함수를 콜스택으로 가져온다.

<br/><br/>
<br/><br/>

# 2. 자바스크립트의 엔진과 웹 APIs(브라우저)

## 1. 브라우저의 web APIs를통해 등록된 콜백함수는 어떻게 동작하는가?

1. 우리가 작성한 코드내용중 어떤함수가 web API(ex. setTimeout))를 호출한다고 가정.
2. setTimeout이 콜스택에 등록됨.
3. 콜스택에서 지워지면서 타이머 작동(타이머와 자바스크립트 엔진은 병렬적으로 실행됨으로 콜스택에 등록되어있는 이후의 함수가 계속해서 실행).
4. 타이머가 지정했던 시간이 되면 콜백함수를 태스크 큐에 등록.(자료구조중 하나인 FIFO구조로동작)
5. 태스크 큐에 등록된 콜백함수는 콜스택과 큐를 관찰하는 이벤트 루프에의해 콜스택에 등록된 함수가 모두 실행되어 콜스택이 비워졌을때 테스크 큐에 등록된 콜백함수를 콜스택으로 이동시켜 실행시킨다.

- eventListener에의해 등록된 콜백함수를 또 예로들면, 만약 클릭이벤트를 등록해놓고 이벤트가 발생하게되면, 등록된 콜백함수가 테스크 큐에 등록되고, 이후 콜스택이 비워지면 이벤트루프에의해 테스크 큐에 등록된 콜백함수가 콜스택으로 이동되어 실행된다.

## 1. Queue.

- 자료구조중 하나.(FIFO: first in first out)

<br/><br/>

### 1) task Queue

<img width="645" alt="스크린샷 2022-01-02 오후 1 44 59" src="https://user-images.githubusercontent.com/58588011/147866507-051e822b-2aac-4834-8f19-624873208e48.png">

- setTimeOut , event Listener, 일반적인 함수 등에 등록된 **콜백함수**가 등록되는 Queue.
- 테스크큐에 등록된 함수는 언제실행되는가? 이벤트루프에의해 콜스택으로 옮겨짐으로써 실행됨.(콜스택이 비워졌을떄)
- **microtask queue에대비하여 한루프에 한개의 콜백함수만 옮김**.

### 2) microtask Queue

<img width="638" alt="스크린샷 2022-01-02 오후 1 45 06" src="https://user-images.githubusercontent.com/58588011/147866503-7e2c6b6c-5a3c-44a8-846f-ae54b214ac59.png">

- promise(then), mutation observer에 등록된 **콜백함수**가 등록되는 Queue.

- 모든 콜백함수가 옮겨질때까지 이벤트루프가 microtask Queue에 머무른다.

- microtask Queue에 이벤트 루프가 머무르는동안 새로운 콜백함수가 등록되었을시, 그 콜백함수도 콜스택으로 이동시킬떄까지 머무른다. 즉, microtask queue 가 텅텅빌때까지 이벤트루프는 micro Queue에 머무른다.

<br></br>
<br></br>

## 3) requestAnimationFrame(callback) web API queue.

<img width="615" alt="스크린샷 2022-01-02 오후 12 34 04" src="https://user-images.githubusercontent.com/58588011/147865347-367a1cb0-6c0d-4b6d-8096-f9e5c66d6f22.png">

- requestAnimationFrame(callback)에 콜백함수를 등록해놓으면, requestAnimationFrame큐에 콜백함수가 쌓이게되고, 이후 화면에서의 어떤 애니메이션등이 발생하여 **리페인트가 진행되기 전에** 큐에 등록된 콜백함수들을 순서대로 실행시킨후 리페인트가 진행된다.

<br/><br/>
<br/><br/>

## 2. Event Loop

 <img width="700" alt="자바스크립트 런타임 환경" src="https://user-images.githubusercontent.com/58588011/118661257-ea5c0080-b829-11eb-84ed-d9a31845fb31.png">

- 콜스택과 큐를 주기적으로 감시(무한루프).
- 콜스택이 비어져있다면, 큐에있는 콜백함수를 옮겨줌.
- 콜스택에 함수가있다면, 그함수가 종료가될떄까지 이벤트루프가 콜스택에서 머무른다.

  - 시간이 오래걸리는 함수가 존재할시, 화면의 업데이트가 늦어지는 이유.
  - 끝나지않는 콜백함수를 등록할시 이벤트루프가 콜스택에서 머무르게되기떄문에 리페인팅이 발생하지않음.
  - 사용자입장에서는 흔히말하는 렉이걸린 상황이된다.

- 브라우저는 사용자에게 1초에 60프레임으로 업데이트한내용을 보여주려함. → 60fps(16.7ms)

  - 16.7ms 안에 업데이트가 이루어져야 사용자가 화면을 자연스럽게 볼 수 있기 때문에.

- 이벤트 루프가 한바퀴를 도는데 걸리는 시간은1ms도 걸리지않는다.

  - 따라서 한루프를 도는데 무조건 리페인트를 진행 할 필요가 없음.

  - 브라우저마다 다르지만 대부분 16.7ms당 한번씩 리페인트 실행.


